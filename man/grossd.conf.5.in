.Dd April 21, 2008
.Dt GROSSD.CONF 5 CON
.Os
.Sh NAME
.Nm grossd.conf
.Nd Greylisting of Suspicious Sources daemon configuration file
.Sh SYNOPSIS
.Pa @sysconfdir@/etc/grossd.conf
.Sh DESCRIPTION
.Xr grossd 8
reads configuration data from
.Pa @sysconfdir@/etc/grossd.conf
(or the file specified with
.Fl f
on the command line). 
An example configuration file is installed by default. You have to
set some configuration options in order to get grossd running in 
your environment. The format is as follows:
.Pp
.Dl name = value Oo ; param Oc ...
.Pp
Not all options accept parameters - 
refer to individual descriptions. The comment separator is 
.Ql # ,
everything after it is ignored by the config file parser.
.Ss Network configuration options
.Bl -tag -width Ds
.It Cm host
is the address the server should listen for queries. Default is
.Ad localhost .
.It Cm port
is the port the server should listen for queries. Default is
.Ad 5525 .
.It Cm sync_listen
is the address to listen for communication with the peer. It
defaults to
.Cm host
setting.
.It Cm sync_peer
is the address of the peer used when running in clustered mode.
.It Cm sync_port
is the tcp port number to listen to and connect to in communication
with the peer. Default is
.Ad 5524 .
.It Cm status_host
is the address grossd
listens for status queries. Default is localhost.
.It Cm status_port
is the port number grossd
listens for status queries. Default is
.Ad 5522 .
.It Cm protocol
activates the server protocols grossd
will support. Valid settings are 
.Sq sjsms ,
.Sq postfix
and
.Sq milter .
.It Cm milter_listen
is the socket address for the Milter service. The format is
.Ad proto:port@host .
Refer to Milter documentation for the specifics.
.El
.Ss Core server options
Most probably you can leave these to default settings. If your daily
mail flow exceeds millions a day you may want to tweak 
.Cm query_timelimit
and/or
.Cm pool_maxthreads .
If you run grossd in a server with limited memory you may want to adjust
.Cm filter_bits . 
.Bl -tag -width Ds
.It Cm filter_bits
is the size of the Bloom filter. Size will be 2^
.Cm filter_bits .
Lowering this value will increase the probability of false matches in each individual
filter. Default is 24.
.It Cm number_buffers
is the number of filter used in the ring queue. Raising this value will cause
an entry to stay in the server's memory longer. Default is
.Sq 8 .
.It Cm rotate_interval
is the number of seconds between filter rotations. Let
.Ms N := 
.Cm number_buffers
and 
.Ms I :=
.Cm rotate_interval
An entry will stay in the server's memory for
.Ms N - 0.5 * I
seconds on average. Defaults to 3600 seconds
.Pq one hour .
.It Cm update
is the way server updates the database. Valid options are 
.Sq grey
and
.Sq always .
If set to
.Sq grey ,
which is the default, grossd will update the database only if response is
.Dv STATUS_GREY .
Setting it to
.Sq always
may reduce the impact on DNS servers.
.It Cm grey_mask
is the mask for grossd to use when matching
.Ad client_ip
against the database. Default is 24, which makes grossd
to treat addresses like
.Ad a.b.c.d
as
.Ad a.b.c.0 .
Setting
.Cm grey_mask
to 32 makes grossd to require that consecutive attempts are
made from the same
.Ad client_ip.
.It Cm statefile
is the full path of the file that the server uses to store
the state information. Default is not to have a statefile. You may
want to configure a 
Cm statefile
especially if you do not configure replication.
.It Cm pidfile
is the full path of the file grossd writes its pid into.
You can set parameter
.Sq check ,
if you want to keep grossd from starting, should pidfile already exist.
.El
.Ss Query constraints
.Bl -tag -width Ds
.It Cm grey_delay
is the time in seconds new triplets are kept on the greylist. Default is 180.
.It Cm query_timelimit
is the query timeout in milliseconds. You may have to adjust this if you
exceed millions of queries a day.
.It Cm pool_maxthreads
is the maximum threadcount per pool. You may have to raise the limit from
the default if you get more than 100 queries per second and/or have slow
DNS servers. Rule of thumb would be to decide how many queries you want
grossd to be able to handle per second, and multiply that with
.Cm query_timelimit
.Pq in seconds, of course .
It defaults to 100.
.El
.Ss Configuring server responses
.Bl -tag -width Ds
.It Cm block_threshold
is the threshold after which grossd sends 
a permanent error to the client. Every check that considers
.Ad client_ip
as suspicious returns a value
.Pq check weight .
When sum of these values gets equivalent or greater than
.Cm block_threshold 
grossd sends a
.Cm STATUS_BLOCK
response. Default is 0 which disables this functionality.
.It Cm block_reason
is the reason given when client is too suspicious, see
Cm block_threshold .
Default is
.Sq Bad reputation .
.It Cm grey_threshold
is analogous to 
.Cm block_threshold ,
except at the threshold grossd sends a
.Dv STATUS_GREY
response.
.El
.Ss Logging options
.Bl -tag -width Ds
.It Cm log_method
is used to choose the logging method. Currently the only implemented method is
.Sq syslog ,
which is the default.
.It Cm log_level
sets the logging verbosity. Possible
.Cm log_level
settings in the order of increasing verbosity are
.Sq error ,
.Sq warning ,
.Sq notice ,
.Sq info
and
.Sq debug .
.Cm log_level
defaults to
.Sq info .
.It Cm syslog_facility
is the facility syslog sends log messages with. It defaults to
.Sq mail .
.It Cm stat_type
is the name of the requested statistic. It is of multivalued type. The
valid options are
.Bl -tag -offset 2n -width 20n -compact
.It Sq full
log all possible statistics,
.It Sq none
no statistics logging,
.It Sq status
basic set of statistics, 
.It Sq since_startup
basic set since the startup
and
.It Sq delay 
log processing delay statistics.
.El
.Pp
Default is
.Sq none .
Setting both
.Sq none
and
.Sq full
is undefined.
.It Cm stat_interval
is the number of seconds between status log entries. Default is 3600.
.El
.Ss Configuring checks
.Bl -tag -width Ds
.It Cm check
is a multivalued option, that is, you can configure multiple checks by
setting
.Cm check
option multiple times. Currently implemented checks
are
.Sq dnsbl ,
.Sq dnswl ,
.Sq rhsbl
and
.Sq blocker .
Refer to sections describing the checks below. If you don't configure
any checks grossd will act as a traditional greylisting server.
.It Cm dnsbl
is a DNS domain name of the dnsbl that
.Sq dnsbl
.Cm check
will query. There are no defaults, but the default configuration file
lists a few as an example. If you have any locally administrated
block lists take into account that grossd makes all queries as
fully qualified. You may assign different weights for the dnsbl's,
default weight is 1.
Refer to
.Cm grey_threshold
and
.Cm block_threshold
about the weights.
.Cm dnsbl
is a multivalued option.
.It Cm dnswl
is analogous to
.Cm dnsbl .
Remember that
.Cm dnswl
is a
.Em definitive
check, that is grossd waits for the check to complete before deciding
how to respond. This may cause unwanted latency, although you can adjust
the maximum latency by
.Cm query_timelimit
option. Highly recommended if you use grossd
as a traditional greylister. This is a multivalued option.
.It Cm rhsbl
is analogous to
.Cm dnsbl ,
but the check is made against the right hand side
.Pq right hand side block list
of the sender address, that is the domain part of the address.
This is a multivalued option.
.It Cm blocker_host
is the host name of the Sophos blocker server. This is used only if
.Cm check = blocker
is set.
.It Cm blocker_port
is the TCP port of the Sophos blocker service. Default is 4466.
.It Cm blocker_weight
is the weight of the blocker check. See description of
.Cm grey_threshold
and
.Cm block_threshold
regarding the weights.
.El
.Ss Sun Java System Messaging Server specific options
You may configure the responses grossd sends over to grosscheck
library. 
.Bl -tag -width Ds
.It Cm sjsms_response_grey
is the mapping result template grossd uses for a
.Dv STATUS_GREY
result. Default is
.Sq Li $X4.4.3|$NPlease$ try$ again$ later.
.It Cm sjsms_response_match
is the mapping result template grossd uses for a
.Dv STATUS_MATCH
result. Default is
.Sq Li $Y .
.It Cm sjsms_response_trust
is the mapping result template grossd uses for a
.Dv STATUS_TRUST
result.  Default is 
.Sq Li $Y .
.It Cm sjsms_response_block
is the mapping result template grossd uses for a
.Dv STATUS_BLOCK
result. Default is
.Sq Li $N%reason%, where
.Sq %reason%
is the template for the reason string.
.El
.Sh MTA CONFIGURATION
.Ss Sun Java System Messaging Server
You have to add a mapping entry to set
.Nm SJSMS
to query grossd. It's also a good idea to exclude
.Ad postmaster
and
.Ad abuse
addresses before querying grossd.
Here is an example:
.Bd -literal -offset 2n
ORIG_MAIL_ACCESS

! allow all DSNs and MDNs
  TCP|*|*|*|*|*|*|tcp_local||*|*  $Y$E
! allow all incoming mail to postmaster and abuse
  TCP|*|*|*|*|*|*|tcp_local|*|*|postmaster@*  $Y$E
  TCP|*|*|*|*|*|*|tcp_local|*|*|abuse@*  $Y$E
! use gross to check all triplets (client_ip,sender,recipient)
  TCP|*|*|*|*|SMTP/*|*|tcp_local|*|*|*  $[@libdir@/grosscheck.so,grosscheck,10.10.13.1,10.10.13.2,5525,$2,$=$8$_,$=$6$_,$=$4$_]
.Ed
.Pp
Mapping call parameters are as follows:
.Bl -enum -offset indent -compact
.It
full path of the
.Lb grosscheck.so
.It
function name to call (always
.Sq grosscheck )
.It
first server's IP address,
.It
second server's IP address,
.It
UDP port for server connections,
.It
SMTP client's IP address,
.It
envelope sender's email address,
.It
envelope recipient's email address,
.It
HELO/EHLO string. 
.El
.Ss Postfix
Grossd implements native Postfix policy delegation protocol. Just specify
grossd at the
.Cm smtpd_recipient_restrictions
in the main configuration file
.Pp
main.cf :
.Bd -literal -offset 2n
/etc/postfix/main.cf:
    smtpd_recipient_restrictions =
        ... 
        reject_unauth_destination 
        check_policy_service inet:host:port
        ...
.Ed
.Pp
Refer to Postfix documentation at
.Ad http://www.postfix.org
for specifics.
.Ss Exim
Exim can be configured to query grossd via
.Nm Postfix
policy delegation protocol. 
.Pp
Main section:
.Bd -literal -offset 2n
GROSS_QUERY = sender=$sender_address\\n\\
  recipient=$local_part@$domain\\n\\
  client_address=$sender_host_address\\n\\
  grossd_mode=single\\n\\n
.Ed
.Pp
Acl section:
.Bd -literal -offset 2n
# gross
warn
  set acl_c0 = ${readsocket{inet:127.0.0.1:5525}{GROSS_QUERY}}

defer
  message = Please try again later.
  condition = ${if match {$acl_c0}{action=defer_if_permit}}

deny
  message = ${if match {$acl_c0}{action=reject (.*)}{$1}\\
    {Rejected by Gross.}}
  condition = ${if match {$acl_c0}{action=reject}} 
.Ed
.Sh "SEE ALSO"
.Xr grossd 8
.Rs
Gross project site:
.Ad http://code.google.com/p/gross/
.Re
.Rs
Bloom filters:
.Ad http://en.wikipedia.org/wiki/Bloom_filter
.Re
.Sh AUTHORS
.An Eino Tuominen Aq eino@utu.fi
.An Antti Siira Aq antti@utu.fi
